<!DOCTYPE html>
<html>
 <head>
   <meta charset="UTF-8">
   <title>a very occasional diary @ Nikita Danilov | Confessions of Microsoft developer</title>
   <link rel="stylesheet" href="style.css">
   <style></style>
   <script async src="https://www.googletagmanager.com/gtag/js?id=G-WEM34DWDR2"></script>
<script>
window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-WEM34DWDR2');
</script>
   
 </head>
 <body>
   <a name="confessions-microsoft"></a><div class="column"><header>Confessions of Microsoft developer</header>
<a name="confessions-microsoft-00000"></a><p style="margin-left: 3em;"><a href="http://blogs.msdn.com/larryosterman/archive/2004/08/12/213681.aspx">As a simple example, when Windows started up</a>, it increased the size of msdos&#x27;s  internal file table (the <code class="inline">SFT</code>, that&#x27;s the table that was created by the  <code class="inline">FILES=</code> line in <code class="inline">config.sys</code>).  It did that to allow more than 20 files to be  opened on the windows system (a highly desirable goal for a multi-tasking  operating system).  But it did that by using an undocumented API call, which  returned a pointer to a set of “interesting” pointers in msdos. It then indexed  a known offset relative to that pointer, and replaced the value of the master  <code class="inline">SFT</code> table with its own version of the <code class="inline">SFT</code>.  When I was working on msdos  4.0, we needed to support Windows.  Well, it was relatively easy to guarantee  that our SFT was at the location that Windows was expecting.  But the problem  was that the msdos 4.0 <code class="inline">SFT</code> was 2 bytes larger than the msdos 3.1 <code class="inline">SFT</code>.  In  order to get Windows to work, I had to change the DOS loader to detect when  win.com was being loaded, and if it was being loaded, I looked at the code at  an offset relative to the base code segment, and if it was a <code class="inline">MOV</code> instruction,  and the amount being moved was the old size of the <code class="inline">SFT</code>, I patched the  instruction in memory to reflect the new size of the <code class="inline">SFT</code>!  Yup, msdos 4.0  patched the running windows binary to make sure Windows would still continue to  work.</p>
<a name="confessions-microsoft-00001"></a><p>And these are the people who <i>design</i> and implement most widely used software in the world. Which is a scary place indeed.</p><footer><a href="concurrency-and-recovery.html#concurrency-and-recovery">&lt;</a>&nbsp;<a href="series_blog_compact_reverse.html">blog</a>&nbsp;<a href="could-be-done.html#could-be-done">&gt;</a>&nbsp;&nbsp;&nbsp;<a href="question.html#question">&lt;</a>&nbsp;<a href="series_timeline_compact_reverse.html">timeline</a>&nbsp;<a href="monster-desktop.html#monster-desktop">&gt;</a>&nbsp;&nbsp;&nbsp;</footer></div>
 </body>
</html>
